#!/usr/bin/env sos-runner
#fileformat=SOS1.0


[patch]
parameter: version = str
sh:
	perl -pi.bak -e "s/^__version__ = .*/__version__ = '${version}'/" ../sos/_version.py


[pip]
# check the version of the latest version
cur_ver = get_output("pip show sos | grep Version | cut -d' ' -f2").strip()

# do not upload if the version on pip is the current one
stop_if(cur_ver == version)

sh:	workdir='..'
	python setup.py sdist upload
	pip install sos --upgrade

[update_docker]
# add documentation to Docker container
depends: executable('docker')

# copy doc over
run: workdir='..'
    rm -rf development/docker-notebook/documentation \
        development/docker-notebook/tutorials \
        development/docker-notebook/examples
    # copy only ipynb and .sos files to docker
    rsync -av --prune-empty-dirs --include "*/" --exclude ".ipynb_checkpoints" \
        --include "*.ipynb" --include "*.sos" --exclude "*" \
        doc/documentation doc/tutorials doc/examples development/docker-notebook

# update docker file
run:
    cp docker-notebook/Dockerfile.in docker-notebook/Dockerfile
    echo "COPY tutorials /home/jovyan/work/tutorials" >> docker-notebook/Dockerfile
    echo "COPY examples  /home/jovyan/work/examples" >> docker-notebook/Dockerfile
    echo "COPY documentation /home/jovyan/work/documentation" >> docker-notebook/Dockerfile

# update docker and push
run:
	docker build --no-cache -t mdabioinfo/sos docker-base
	docker push mdabioinfo/sos

	docker build --no-cache -t mdabioinfo/sos-notebook docker-notebook
	docker push mdabioinfo/sos-notebook


[publish]

run: workdir='../doc'
	for f in `ls ./documentation/*.ipynb`; do
        	jupyter nbconvert --to html $f
	done

	mv ./documentation/*html ../website/doc/documentation_html/

	for f in `ls ./tutorials/*.ipynb`; do
        	jupyter nbconvert --to html $f
	done

	mv ./tutorials/*html ../website/doc/tutorial_html/
	cd ..
	git subtree split --prefix website -b gh-pages
	git push -f origin gh-pages:gh-pages
	git branch -D gh-pages

[default]
sos_run('patch + pip + update_docker + publish')
